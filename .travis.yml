language: go

go:
  - 1.22.x

env:
  - GO111MODULE=on

before_install:
  - go mod tidy

script:
  - go test ./... -v -coverprofile=coverage.out -covermode=atomic
  - total=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
  - echo "Total coverage: ${total}%"
  - if (( $(echo "$total < 80.0" | bc -l) )); then echo "❌ Coverage below 80%!"; exit 1; fi

after_success:
  # Upload coverage to Codecov (optional)
  - bash <(curl -s https://codecov.io/bash) || echo "Codecov upload failed"

deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file:
    - coverage.out
  skip_cleanup: true
  on:
    branch: main
    condition: "$(echo $total | awk '{exit ($1 >= 80.0) ? 0 : 1}')"
